---
title: "Philadelphia Tree Canopy" 
author: "Palak Argarwal, Anna Duan, Kyle McCarthy" 
date: 
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE,message = FALSE,cache=TRUE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
library(knitr)
```


```{r libraries_Data_Cleaning, message=FALSE, warning=FALSE, include=TRUE}
library(tidyverse)
library(tidycensus)
library(sf)
library(kableExtra)
library(dplyr)
library(viridis)
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
```

```{r libraries_Data_Cleaning, message=FALSE, warning=FALSE, include=TRUE}

TreeCanopy <- st_read("C:/Users/Kyle McCarthy/Documents/Practicum/TreeCanopyChange_2008_2018.shp")%>%
  st_transform('ESRI:102728')

TreeCanopy$SHAPE_Area <- st_area(TreeCanopy)

Philadelphia <- st_read("http://data.phl.opendata.arcgis.com/datasets/405ec3da942d4e20869d4e1449a2be48_0.geojson")%>%
  st_transform('ESRI:102728')
  

```

```{r Fishnet, message=FALSE, warning=FALSE, include=TRUE}
fishnet <- 
  st_make_grid(Philadelphia,
               cellsize = 1600) %>%
  st_sf() %>%
  mutate(uniqueID = rownames(.))%>%
  st_transform('ESRI:102728')

TreeCanopyLoss <- 
  TreeCanopy%>% 
  filter(CLASS_NAME == "Loss")%>%
  mutate(AreaM= SHAPE_Area * .093903)

TreeCanopyLoss2<- 
  fishnet%>%
  st_join(TreeCanopyLoss)%>%
  group_by(uniqueID)%>%
  summarise(Area = sum(AreaM))%>%
  mutate(pctLoss = Area / 1600)%>%
  mutate(pctLoss = as.numeric(pctLoss))

ggplot()+ 
  geom_sf(data = TreeCanopyLoss2, aes(fill = pctLoss))+ 
  scale_fill_viridis()+
  labs(title= "Tree Canopy Loss/ Grid Cell Size")+
  mapTheme()
  
```

```{r Neighborhood, message=FALSE, warning=FALSE, include=TRUE}

Neighborhood <- st_read("C:/Users/Kyle McCarthy/Documents/Practicum/Data/Neighborhoods/Neighborhoods_Philadelphia.shp")%>%
  st_transform('ESRI:102728')

NeighborhoodTreeLoss<- 
  Neighborhood%>%
  st_join(TreeCanopyLoss)%>%
  group_by(NAME)%>%
  summarise(Area = sum(AreaM))%>%
  mutate(AreaNeighborhood = st_area(Neighborhood))%>%
  mutate(AreaNeighborhood = as.numeric(AreaNeighborhood))%>%
  mutate(pctLoss = Area / AreaNeighborhood)%>%
  mutate(pctLoss = as.numeric(pctLoss))

ggplot()+ 
  geom_sf(data = NeighborhoodTreeLoss, aes(fill = pctLoss))+ 
  scale_fill_viridis()+
  labs(title= "Tree Canopy Loss/ Neighborhood Size")+
  mapTheme()

```
```{r Tree Canopy All, message=FALSE, warning=FALSE, include=TRUE}

TreeCanopy_attempt<- 
  fishnet%>%
  st_join(TreeCanopy)%>%
  group_by(uniqueID)%>%
  summarise(Total_Canopy_Area = sum(SHAPE_Area))%>%
  mutate(Total_Canopy_Area = as.numeric(Total_Canopy_Area))%>%
  st_join(TreeCanopy)

TreeCanopy_fishnet <- 
  TreeCanopy_attempt%>%
  group_by(uniqueID, CLASS_NAME, Total_Canopy_Area)%>%
  summarise(Area = sum(SHAPE_Area))%>%
  filter(CLASS_NAME == "Loss")%>% 
  mutate(pct = Area / Total_Canopy_Area)

TreeCanopy_fishnet <- 
  TreeCanopy_fishnet%>%
  mutate(pct = as.numeric(pct))

ggplot()+ 
  geom_sf(data = TreeCanopy_fishnet, aes(fill = pct))+ 
  scale_fill_viridis()+
  labs(title= "Tree Loss / Total Tree Area in Grid Cell")+
  mapTheme()

```
```{r Tree Canopy All Neighborhoods, message=FALSE, warning=FALSE, include=TRUE}
TreeCanopy_attempt_N<- 
  Neighborhood%>%
  st_join(TreeCanopy)%>%
  group_by(NAME)%>%
  summarise(Total_Canopy_Area = sum(SHAPE_Area))%>%
  mutate(Total_Canopy_Area = as.numeric(Total_Canopy_Area))%>%
  st_join(TreeCanopy)

TreeCanopy_Neighborhood <- 
  TreeCanopy_attempt_N%>%
  group_by(NAME, CLASS_NAME, Total_Canopy_Area)%>%
  summarise(Area = sum(SHAPE_Area))%>%
  filter(CLASS_NAME == "Loss")%>% 
  mutate(pct = Area / Total_Canopy_Area)%>%
  mutate(pct = as.numeric(pct))


ggplot()+ 
  geom_sf(data = TreeCanopy_Neighborhood, aes(fill = pct))+ 
  scale_fill_viridis()+
  labs(title= "Tree Loss / Total Tree Area in Neighborhood")+
  mapTheme()
```